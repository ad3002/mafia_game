# Спецификация для разработки приложения "Мафия"

*Версия 1.0 | Дата: 28.02.2025 | Статус: Финальная*

## 1. Обзор проекта

Приложение для игры в "Мафию" с автоматизированным гейммастером, которое заменяет необходимость в ведущем. Приложение предназначено для использования на одном устройстве, которое передается между игроками.

### 1.1. Цели проекта
- Создать удобное приложение для игры в "Мафию" без необходимости в живом ведущем
- Обеспечить справедливое распределение ролей и автоматизацию игрового процесса
- Минимизировать возможности для читерства и получения несанкционированной информации
- Создать интуитивно понятный интерфейс, подходящий даже для новичков

### 1.2. Целевая аудитория
- Компании друзей возрастом 14+
- Участники вечеринок и настольных игр
- Любители психологических игр

## 2. Технический стек

- Frontend: Next.js
- UI: Tailwind CSS
- Иконки/компоненты: Lucid
- Форма: T-Conkey
- Хранение данных: Local Storage (без бэкенда)
- Подход: Serverless
- Управление состоянием: React Context или Redux
- Анимации: Framer Motion (для улучшения UX при переходах между фазами)
- Звуки: Howler.js (для звуковых эффектов и атмосферы)
- PWA: Использование прогрессивного веб-приложения для оффлайн-доступа

### 2.1. Требования к производительности
- Моментальная реакция на действия пользователя
- Оптимизация размеров бандла для быстрой загрузки
- Корректная работа на мобильных устройствах с разным размером экрана

## 3. Ролевая модель и масштабируемость

### 3.1. Стандартная игра (для 10 игроков)
- 6 мирных жителей
- 1 шериф
- 2 обычные мафии
- 1 дон мафии

### 3.2. Подготовка к масштабированию
В будущих версиях нужно предусмотреть возможность добавления:
- Различных конфигураций ролей для разного количества игроков (7-12+)
- Дополнительных ролей (доктор, маньяк, журналист и т.д.)
- Пользовательских настроек игры (длительность дня/ночи, специальные правила)

### 3.3. Характеристики ролей
**Мирный житель:**
- Не имеет особых способностей
- Основная задача - выявить мафию в процессе обсуждения
- Голосует днем

**Шериф:**
- Может проверять одного игрока за ночь
- Получает информацию, является ли проверяемый мафией или нет
- Не может отличить дона от обычной мафии

**Обычная мафия:**
- Знает, кто входит в команду мафии
- Голосует днем как обычный житель
- Становится доном, если текущий дон убит

**Дон мафии:**
- Лидер команды мафии
- Решает, кого убить ночью
- Может проверить одного игрока за ночь (узнать, является ли шерифом)
- Координирует действия команды мафии

## 4. Пользовательский путь

### 4.1. Начало игры
- Экран ввода имен для 10 игроков
- Каждый игрок создает 4-значный PIN-код для идентификации
- Система автоматически распределяет роли

### 4.2. Интерфейс
- Основной экран представляет собой круг из аватарок игроков
- Каждая аватарка содержит:
  - Имя игрока
  - Индикатор статуса (жив/мертв)
  - Подсветка активного игрока
  - Индикатор "выставлен на голосование" (во время дневной фазы)
  - Счетчик голосов против игрока (при голосовании)
- В центре круга размещается:
  - Таймер текущей фазы (с визуальным и звуковым оповещением)
  - Основные игровые сообщения и инструкции
  - Индикатор текущей фазы (день/ночь/голосование)
  - Лог последних событий (скрываемый/раскрываемый)

### 4.3. Дизайн и атмосфера
- Темный режим по умолчанию для ночной атмосферы
- Цветовая кодировка различных фаз:
  - Синий/темно-синий для ночи
  - Желтый/оранжевый для дня
  - Красный для голосования и критических моментов
- Анимированные переходы между фазами для подчеркивания изменения состояния игры
- Тематические иконки для различных ролей (шляпа для дона, значок для шерифа)
- Минималистичный, но атмосферный интерфейс с акцентом на UX

### 4.4. Механика передачи устройства и безопасность
- После каждого действия появляется экран передачи устройства с нейтральным содержимым
- Для доступа к своей роли и действиям игрок должен ввести свой PIN-код
- PIN-код вводится через специальную клавиатуру с рандомизированным расположением цифр (защита от подглядывания)
- После ввода PIN-кода показывается экран подтверждения ("Это действительно вы, [Имя игрока]?")
- После завершения хода игрок нажимает кнопку "Завершить"
- Система автоматически блокирует экран через 3-5 секунд бездействия во время критических фаз
- Реализован механизм защиты от случайных нажатий (подтверждение важных действий)
- При передаче устройства используется затемнение экрана и маскировка конфиденциальной информации

## 5. Игровая механика

### 5.1. Ночная фаза
1. Объявление наступления ночи (с анимацией и звуковым сопровождением)
2. Система последовательно вызывает игроков согласно порядку ходов:
   
   **Дон мафии:**
   - Вводит PIN-код для аутентификации
   - Видит всех живых игроков и выбирает жертву для убийства
   - Выбирает одного игрока для проверки (чтобы узнать, шериф ли он)
   - Подтверждает свой выбор и передает устройство
   
   **Обычная мафия (по очереди):**
   - Получает информацию о том, кого решил убить дон
   - Не принимает решений, но знакомится с текущей ситуацией
   
   **Шериф:**
   - Вводит PIN-код для аутентификации
   - Выбирает одного игрока для проверки
   - Получает результат проверки (мафия/не мафия)
   - Подтверждает ознакомление с информацией

3. Анимация окончания ночи и переход к объявлению результатов

### 5.1.1. Визуализация результатов проверок
- Шериф видит результат своей проверки с четким визуальным разделением:
  - Красный индикатор для мафии
  - Зеленый индикатор для мирных жителей
- Дон мафии видит результат своей проверки:
  - Специальный индикатор для шерифа
  - Нейтральный индикатор для всех остальных ролей

### 5.2. Дневная фаза
1. **Рассвет и объявление результатов ночи:**
   - Анимация восхода солнца с соответствующим звуковым сопровождением
   - Драматичное объявление результатов ночи (кто убит)
   - Обновление статусов игроков и визуальное выделение убитого
   - Проверка условий окончания игры

2. **Обсуждение:**
   - Настраиваемый таймер для общего обсуждения (по умолчанию 5-7 минут)
   - Круговая система выступлений:
     - Каждый игрок получает фиксированное время для высказывания (30-60 секунд)
     - Визуальное выделение текущего выступающего
     - Индикатор оставшегося времени
   - Возможность пропустить свое выступление или передать слово другому игроку

3. **Выставление на голосование:**
   - Каждый живой игрок может выставить одного игрока во время своего хода
   - У аватарок других игроков появляется кнопка "Выставить"
   - Визуальное выделение выставленных игроков
   - Фиксирование аргументации выставления (опционально, можно включить в настройках)
   - Возможность отказаться от выставления кого-либо

4. **Последнее слово:**
   - Каждый выставленный игрок получает 30 секунд на последнее слово
   - Система автоматически переключает между выставленными игроками

5. **Голосование:**
   - Каждый живой игрок голосует за одного из выставленных путем ввода своего PIN-кода
   - Наглядная визуализация процесса голосования (без раскрытия конкретных голосов)
   - Индикатор количества проголосовавших игроков
   - После завершения голосования - анимация подсчета голосов
   - Объявление результатов с визуальным отображением распределения голосов
   - Драматичное объявление игрока, покидающего игру

6. **Обновление статусов:**
   - Обновление статуса выбывшего игрока
   - Проверка условий окончания игры
   - Переход к следующей ночи (если игра продолжается)

### 5.3. Наследование ролей и специальные механики

#### 5.3.1. Система наследования
- Если дон мафии погибает, система автоматически назначает одного из оставшихся мафиози новым доном
- При назначении нового дона, система явно уведомляет игрока о его повышении при следующем входе
- Новый дон получает все привилегии и возможности стандартной роли дона
- Обычные мафии не участвуют в принятии решений, но знают всех членов своей команды

#### 5.3.2. Специальные механики
- **Единогласное решение:** Если все живые игроки голосуют за одного и того же игрока, он немедленно выбывает (без права последнего слова)
- **Равенство голосов:** В случае равенства голосов, никто не выбывает в данном раунде
- **Система подозрений:** Игра отслеживает, кто кого выставлял в предыдущих раундах (доступно для просмотра всем игрокам)
- **Последовательность событий:** Четкая визуализация последовательности действий каждой ночи и дня для легкого понимания происходящего

#### 5.3.3. Система подсказок
- Для новичков система предлагает контекстные подсказки о текущей фазе и доступных действиях
- Подсказки можно отключить в настройках игры
- Подсказки никогда не раскрывают секретную информацию о ролях других игроков

## 6. Критические функции

### 6.1. Система объявлений результатов
- Кто убит ночью
- Кто выбыл после голосования
- Текущее состояние игры

### 6.2. Условия победы
- Мафия побеждает, когда количество мафии равно или превышает количество мирных жителей
- Мирные жители побеждают, когда вся мафия уничтожена

### 6.3. История ходов
- Кто за кого голосовал
- Результаты голосований

### 6.4. Безопасность
- Защита от случайных нажатий при передаче телефона
- PIN-код для доступа к роли и действиям

## 7. Управление состоянием и архитектура

### 7.1. Архитектура приложения
- Модульный дизайн с четким разделением ответственности
- Компонентная структура: игра → фазы → действия → интерфейс
- Отдельные модули для:
  - Управления состоянием игры
  - Логики ролей и действий
  - Визуализации и UI
  - Безопасности и проверки PIN-кодов
  - Сохранения и восстановления состояния

### 7.2. Управление состоянием
- Использование React Context или Redux для глобального состояния игры
- Основной стейт хранится в компоненте верхнего уровня
- Иммутабельный подход к обновлению состояния для предотвращения ошибок
- Разделение бизнес-логики и представления

### 7.3. Сохранение и восстановление
- Автоматическое сохранение состояния игры в localStorage после каждого значимого изменения
- Многоуровневая система резервного копирования:
  - Основные данные в localStorage
  - Возможность экспорта/импорта игры (код для восстановления)
  - Регулярное сохранение снэпшотов состояния
- Механизм восстановления после сбоя:
  - Автоматическое обнаружение прерванной игры
  - Предложение восстановить последнее состояние
  - Диагностика и восстановление с минимальной потерей данных

### 7.4. Изоляция и безопасность данных
- Шифрование чувствительных данных о ролях в localStorage
- Разделение публичных и приватных данных игры
- Система разграничения доступа на основе PIN-кодов
- Очистка чувствительных данных из памяти после завершения хода

## 8. MVP первой версии

### Включить в MVP:
- Базовую игровую механику с передачей телефона
- Систему PIN-кодов для идентификации
- Все фазы игры (ночь, день, голосование)
- Основные роли и их функции
- Условия победы и поражения

### Не включать в первую версию:
- Дополнительные роли
- Сложные игровые механики
- Сетевую синхронизацию между устройствами

## 9. Потенциальные узкие места и риски

### 9.1. Технические риски
- **Безопасность при передаче устройства:**
  - Решение: рандомизированное расположение цифр в PIN-клавиатуре, таймеры автоблокировки, экраны перехода
- **Сохранение состояния:**
  - Решение: многоуровневое резервное копирование, постоянная синхронизация с localStorage
- **Удобство ввода PIN-кода:**
  - Решение: оптимизация клавиатуры, возможность восстановления PIN-кода через подтверждение других игроков
- **Производительность и отзывчивость UI:**
  - Решение: оптимизация рендеринга, мемоизация тяжелых компонентов, асинхронная загрузка

### 9.2. UX риски
- **Путаница с правилами:**
  - Решение: контекстные подсказки, встроенное руководство по игре, информационные экраны
- **Сложность интерфейса для новичков:**
  - Решение: режим для новичков с дополнительными пояснениями, пошаговое руководство
- **Раскрытие ролей:**
  - Решение: строгая система безопасности, предотвращение случайного раскрытия информации

### 9.3. Игровой баланс
- **Справедливое распределение ролей:**
  - Решение: проверенный алгоритм рандомизации, возможность проверки честности распределения
- **Баланс между мирными и мафией:**
  - Решение: тщательно продуманные пропорции ролей для разного количества игроков
- **Предотвращение читерства:**
  - Решение: механики, минимизирующие возможность нечестной игры, система PIN-кодов

## 10. Стратегия развития и монетизации

## 11. Метрики успеха и аналитика

### 11.1. Ключевые метрики
- **Вовлеченность:** среднее количество игр на пользователя, продолжительность сессий
- **Удержание:** возвращаемость игроков на 1/7/30 день
- **Завершение игр:** процент игр, доведенных до логического завершения
- **Активность:** количество активных игроков ежедневно/еженедельно/ежемесячно
- **Техническая стабильность:** количество крашей, успешность восстановления после сбоев

### 11.2. Система аналитики
- Встроенная анонимизированная аналитика использования приложения
- Сбор данных о популярных конфигурациях игры
- Отслеживание частоты использования различных ролей
- Анализ баланса (процент побед мирных/мафии)
- Фидбек-система для пользовательских отзывов

### 11.3. Приоритеты оптимизации
- Оптимизация на основе данных о пользовательском пути
- Улучшение наиболее используемых функций
- Регулярное A/B тестирование новых функций перед полным запуском
- Исследование паттернов использования для определения будущих направлений развития

### 10.1. Дорожная карта развития
**Версия 1.0 (MVP):**
- Базовая игровая механика для 10 игроков
- Система PIN-кодов и безопасной передачи устройства
- Минималистичный, но функциональный UI
- Основные роли и механики

**Версия 1.1:**
- Улучшенный UI с анимациями
- Звуковые эффекты и атмосфера
- Режим для новичков с подсказками
- История игр и статистика

**Версия 2.0:**
- Дополнительные роли (доктор, маньяк, журналист)
- Настраиваемые правила и количество игроков
- Темы оформления (классическая, хоррор, киберпанк)
- Система достижений и наград

**Версия 3.0:**
- Мультиустройственный режим (с синхронизацией через QR-код)
- Онлайн-режим игры для удаленных команд
- Голосовое управление
- Интеграция с социальными сетями

### 10.2. Стратегия монетизации
**Бесплатные функции:**
- Базовая игра для 7-10 игроков
- Стандартные роли (мирные, шериф, мафия, дон)
- Основной интерфейс
- Базовая статистика игр

**Премиум-функции (платные):**
- Расширенный набор ролей (15+ уникальных ролей)
- Тематические оформления с уникальной графикой и звуками
- Специальные режимы игры (быстрая игра, профессиональный режим)
- Расширенная статистика и аналитика для отслеживания прогресса
- Возможность сохранять профили игроков между сессиями
- Режим турнира с таблицей лидеров

### 10.3. Маркетинговая стратегия
- Создание сообщества вокруг приложения
- Интеграция с популярными платформами для настольных игр
- Партнерство с компаниями, организующими игры в Мафию
- Система реферальных приглашений
- Регулярные обновления с новым контентом для поддержания интереса
- Сезонные тематические события и специальные режимы